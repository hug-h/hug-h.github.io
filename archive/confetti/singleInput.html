<!--some sort of visual patch, vanilla JS-->
<!--Hugh Clery Ward 20/10/25-->
<!--todo: instructions popover, colour editing-->
<!DOCTYPE html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>confetti</title>

    <style>
        #confetti {
            width: 100%;
            height: 100%;
            font-family: serif;
            z-index: -1;
            position: fixed;
            top: 0;
            left: 0;
            color: black;
            filter: blur(1px);
            font-size: 2vh;

            div {
                width: 100%;
                text-align: center;
                justify-content: space-between;
                font-size: inherit;
                line-height: 1em;
                display: flex;
                padding: 0;
            }
        }

        input {
            background-color: rgba(255, 255, 255, .5);
            width: 33vw;
        }

        .hidden {
            display: none;
        }
    </style>
    <script>
        let density = 100;
        let interval = 100;
        let numInputs = 1;
        let fontSize = 3;
        let confettiInterval;

        function load() {
            build(numInputs);
            animate();
        }

        function animate() {
            if (confettiInterval) { clearInterval(confettiInterval) };
            confettiInterval = setInterval(animConfetti, interval);
        }

        function animConfetti() {
            target = document.getElementById("confetti");
            target.innerHTML = ""
            let rows = checkFontSize(target);
            for (i = 0; i < rows; i++) {
                line = document.createElement("div");
                for (y = 0; y < Math.floor(Math.random() * density + 2); y++) {
                    bit = document.createElement("span")
                    bit.innerHTML = randFigure()
                    if (Math.random() > .5) {
                        bit.style.color = "rgba(255,0,0, 0.8)";
                    }
                    line.appendChild(bit);
                }
                target.appendChild(line);
            }
        }

        function randFigure() {
            return figures[Math.trunc(Math.random() * figures.length)];
        }

        function checkFontSize(targetDiv) {
            targetDiv.style.fontSize = fontSize + "vh";
            return Math.ceil(100 / fontSize);
        }

        let figures = ['*', 'o', ' '];

        //build the site

        function build(nInputs) {
            console.log(figures);
            inputContainer = document.getElementById("inputs");
            inputs.innerHTML = '';
            for (i = 0; i < nInputs; i++) {
                input = document.createElement("input");
                input.type = "text";
                input.id = "word" + i;
                if (i == 0) {
                    input.autofocus = true;
                }
                inputContainer.appendChild(input);
                inputContainer.appendChild(document.createElement("br"));
            }

            //add listener to update the figure array after every keystroke
            inputContainer.addEventListener('keyup', (key) => {
                for (i = 0; i < nInputs; i++) { // probably only gonna work on one array rn but that ok!
                    string = document.getElementById("word" + i).value;
                    words = string.split(' '); //   /([^\s]+)+/.exec(string);
                    figures = [figures[0], figures[1], ' '];
                    words.forEach(word => {
                        figures.push(word);
                    });
                    checkForCmd(string);
                }
            });

            //add listener to hide the inputs on mobile when screen tapped
            document.getElementById("confetti").addEventListener('mousedown', () => {
                inputContainer.classList.toggle("hidden");
            })
        }

        //check inputs for strings of (#_letter_integer) where letter is the i or d charachter
        //#i will change the animation interval
        //#d will change the density of the animation
        function checkForCmd(value) {
            test = /#(d|i|f|mode)(\d+)/.exec(value);
            console.log(test) // testing !!
            if (test) {
                val = test[2];
                switch (test[1]) {
                    case "d":
                        console.log("density" + val);
                        density = val;
                        break;
                    case "i":
                        console.log("interval" + val);
                        interval = val;
                        animate();
                        break;
                    case "f":
                        console.log("fontSize" + val);
                        fontSize = val;
                        break;
                    case "mode":
                        console
                        if (val == 0);
                        window.location.href = 'index.html';
                        break;

                }
            }
            if (/help/.test(value)) { info(); }
        }

        // tutorial mode
        function info() {
            figures[0] = "use #d100 to set density to 100";
            figures[1] = "use #i20 to set interval to 20ms";
            density = 3;
            delay = setTimeout(() => { // delay this code so the text updates first
                interval = 2000;
                animate();
            }, interval + 10);

        }
    </script>
</head>

<body onload="(load())">
    <div id="inputs"></div>
    <div id="confetti" class="gooey"></div>

</body>